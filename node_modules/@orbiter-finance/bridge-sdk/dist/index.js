"use strict";var ke=Object.create;var V=Object.defineProperty;var Ae=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames;var $e=Object.getPrototypeOf,Ee=Object.prototype.hasOwnProperty;var _e=(p,e,t)=>e in p?V(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var Me=(p,e)=>{for(var t in e)V(p,t,{get:e[t],enumerable:!0})},me=(p,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Re(e))!Ee.call(p,i)&&i!==t&&V(p,i,{get:()=>e[i],enumerable:!(n=Ae(e,i))||n.enumerable});return p};var v=(p,e,t)=>(t=p!=null?ke($e(p)):{},me(e||!p||!p.__esModule?V(t,"default",{value:p,enumerable:!0}):t,p)),xe=p=>me(V({},"__esModule",{value:!0}),p);var g=(p,e,t)=>_e(p,typeof e!="symbol"?e+"":e,t);var Ie={};Me(Ie,{ApiService:()=>F,CDNENDPOINT:()=>ie,ENDPOINT:()=>re,OrbiterClient:()=>ce,Router:()=>N,RouterState:()=>pe,RouterType:()=>C});module.exports=xe(Ie);var re=(t=>(t.TESTNET="https://testnet-api.orbiter.finance/sdk",t.MAINNET="https://api.orbiter.finance/sdk",t))(re||{}),ie=(t=>(t.TESTNET="https://testnet-cdn.orbiter.finance/config",t.MAINNET="https://cdn.orbiter.finance/config",t))(ie||{}),C=(t=>(t.EOA="EOA",t.CONTRACT="CONTRACT",t))(C||{});var k=require("@orbiter-finance/vm-core");var S=require("@orbiter-finance/vm-core");var se=v(require("bignumber.js")),R=require("ethers");var f=class{constructor(e){g(this,"_configService");this._configService=e}isValidTransferType(e){return!0}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){throw new Error(`createTransfer need implement, params: 
    srcAddress: ${e}, srcToken: ${JSON.stringify(t)}, dstAddress: ${n}, dstToken: ${JSON.stringify(i)}, value: ${r}, vc: ${a}, 
    routerType: ${s}, makerAddress: ${o}, chainId: ${l}, contractAddress: ${c}, channelId: ${u}`)}async createApprove(e,t,n,i,r){throw new Error(`createApprove need implement, params: 
      ownerAddress: ${e}, spenderAddress: ${t}, approveToken: ${JSON.stringify(n)}, value: ${r}, chainId: ${i}`)}async createAllowance(e,t,n,i){throw new Error(`checkAllowance need implement, params: 
      ownerAddress: ${e}, spenderAddress: ${t}, approveToken: ${JSON.stringify(n)}, chainId: ${i}`)}};var B=[{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"owner",type:"address"},{indexed:!0,internalType:"address",name:"spender",type:"address"},{indexed:!1,internalType:"uint256",name:"value",type:"uint256"}],name:"Approval",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"from",type:"address"},{indexed:!0,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"uint256",name:"value",type:"uint256"}],name:"Transfer",type:"event"},{inputs:[{internalType:"address",name:"owner",type:"address"},{internalType:"address",name:"spender",type:"address"}],name:"allowance",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"spender",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"approve",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"account",type:"address"}],name:"balanceOf",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"decimals",outputs:[{internalType:"uint8",name:"",type:"uint8"}],stateMutability:"view",type:"function"},{inputs:[],name:"name",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[],name:"symbol",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[],name:"totalSupply",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"recipient",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"transfer",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"sender",type:"address"},{internalType:"address",name:"recipient",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"transferFrom",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"}];var O=[{members:[{name:"low",offset:0,type:"felt"},{name:"high",offset:1,type:"felt"}],name:"Uint256",size:2,type:"struct"},{inputs:[{name:"name",type:"felt"},{name:"symbol",type:"felt"},{name:"recipient",type:"felt"}],name:"constructor",outputs:[],type:"constructor"},{inputs:[],name:"name",outputs:[{name:"name",type:"felt"}],stateMutability:"view",type:"function"},{inputs:[],name:"symbol",outputs:[{name:"symbol",type:"felt"}],stateMutability:"view",type:"function"},{inputs:[],name:"totalSupply",outputs:[{name:"totalSupply",type:"Uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"decimals",outputs:[{name:"decimals",type:"felt"}],stateMutability:"view",type:"function"},{inputs:[{name:"account",type:"felt"}],name:"balanceOf",outputs:[{name:"balance",type:"Uint256"}],stateMutability:"view",type:"function"},{inputs:[{name:"owner",type:"felt"},{name:"spender",type:"felt"}],name:"allowance",outputs:[{name:"remaining",type:"Uint256"}],stateMutability:"view",type:"function"},{inputs:[{name:"recipient",type:"felt"},{name:"amount",type:"Uint256"}],name:"transfer",outputs:[{name:"success",type:"felt"}],type:"function"},{inputs:[{name:"sender",type:"felt"},{name:"recipient",type:"felt"},{name:"amount",type:"Uint256"}],name:"transferFrom",outputs:[{name:"success",type:"felt"}],type:"function"},{inputs:[{name:"spender",type:"felt"},{name:"amount",type:"Uint256"}],name:"approve",outputs:[{name:"success",type:"felt"}],type:"function"},{inputs:[{name:"spender",type:"felt"},{name:"added_value",type:"Uint256"}],name:"increaseAllowance",outputs:[{name:"success",type:"felt"}],type:"function"},{inputs:[{name:"spender",type:"felt"},{name:"subtracted_value",type:"Uint256"}],name:"decreaseAllowance",outputs:[{name:"success",type:"felt"}],type:"function"},{inputs:[{name:"recipient",type:"felt"},{name:"amount",type:"Uint256"}],name:"mint",outputs:[],type:"function"},{inputs:[{name:"user",type:"felt"},{name:"amount",type:"Uint256"}],name:"burn",outputs:[],type:"function"}];var le=[{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"}],name:"Transfer",type:"event"},{inputs:[{internalType:"address",name:"to",type:"address"},{internalType:"bytes",name:"data",type:"bytes"}],name:"transfer",outputs:[],stateMutability:"payable",type:"function"},{inputs:[{internalType:"contract IERC20",name:"token",type:"address"},{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"value",type:"uint256"},{internalType:"bytes",name:"data",type:"bytes"}],name:"transferToken",outputs:[],stateMutability:"payable",type:"function"},{inputs:[{internalType:"contract IERC20",name:"token",type:"address"},{internalType:"address[]",name:"tos",type:"address[]"},{internalType:"uint256[]",name:"values",type:"uint256[]"}],name:"transferTokens",outputs:[],stateMutability:"payable",type:"function"},{inputs:[{internalType:"address[]",name:"tos",type:"address[]"},{internalType:"uint256[]",name:"values",type:"uint256[]"}],name:"transfers",outputs:[],stateMutability:"payable",type:"function"}];var de=[{members:[{name:"low",offset:0,type:"felt"},{name:"high",offset:1,type:"felt"}],name:"Uint256",size:2,type:"struct"},{data:[{name:"to",type:"felt"},{name:"amount",type:"Uint256"},{name:"token",type:"felt"},{name:"ext_len",type:"felt"},{name:"ext",type:"felt*"}],keys:[],name:"Transfer",type:"event"},{inputs:[{name:"_token",type:"felt"},{name:"_to",type:"felt"},{name:"_amount",type:"Uint256"},{name:"_ext_len",type:"felt"},{name:"_ext",type:"felt*"}],name:"transferERC20",outputs:[],type:"function"}];var P=class extends f{async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);if(s=="CONTRACT"&&!c)throw new Error("contractAddress is required");let m;if(s==="EOA"){if(e!==n)throw new Error(`EVM EOA transfer not support cross address transfer, srcAddress:${e}, dstAddress:${n}.`);if(t.isNative)m={to:o,value:r,data:"0x"};else{let y=new R.Interface(B),T=o,h=r,b=y.encodeFunctionData("transfer",[T,h]);m={to:t.address,data:b,value:"0"}}}else if(s==="CONTRACT"){let y=new R.Interface(le),T=o,h=(0,R.hexlify)((0,R.toUtf8Bytes)(u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`));if(t.isNative){let b=y.encodeFunctionData("transfer",[T,h]);m={to:c,data:b,value:r}}else{let b=t.address,w=y.encodeFunctionData("transferToken",[b,T,r,h]);m={to:c,data:w,value:"0"}}}return{srcAddress:e,dstAddress:n,value:r,amount:new se.default(r).div(10**t.decimals).toString(),raw:m}}async createApprove(e,t,n,i,r){let a=new R.Interface(B),s=r,o=a.encodeFunctionData("approve",[t,s]),l={to:n.address,data:o,value:"0"};return{ownerAddress:e,spenderAddress:t,value:r,amount:new se.default(r).div(10**n.decimals).toString(),raw:l}}async createAllowance(e,t,n,i){let a=new R.Interface(B).encodeFunctionData("allowance",[e,t]);return{to:n.address,data:a,value:"0"}}};var ae=v(require("bignumber.js")),A=require("starknet");var L=class extends f{isValidTransferType(e){return e!="EOA"}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);if(!c)throw new Error("contractAddress is required");let m=A.uint256.bnToUint256(r),T=new A.Contract(O,t.address).populate("approve",[c,m]),h=new A.Contract(de,c),b=u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`,w=A.shortString.splitLongString(b).map(Se=>A.shortString.encodeShortString(Se)),I=h.populate("transferERC20",[t.address,o,m,w]);return{srcAddress:e,dstAddress:n,value:r,amount:new ae.default(r).div(10**t.decimals).toString(),raw:[T,I]}}async createApprove(e,t,n,i,r){let a=new A.Contract(O,n.address),s=A.uint256.bnToUint256(r),o=a.populate("approve",[t,s]);return{ownerAddress:e,spenderAddress:t,value:r,amount:new ae.default(r).div(10**n.decimals).toString(),raw:o}}async createAllowance(e,t,n,i){return new A.Contract(O,n.address).populate("allowance",[e,t])}};var ye=v(require("bignumber.js"));var U=class extends f{isValidTransferType(e){return e!="CONTRACT"}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);if(e!==n)throw new Error("IMX not support cross address tranfer.");let m=u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`;return{srcAddress:e,dstAddress:n,value:r,amount:new ye.default(r).div(10**t.decimals).toString(),raw:m}}};var fe=v(require("bignumber.js"));var D=class extends f{isValidTransferType(e){return e!="CONTRACT"}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);let m=u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`;return{srcAddress:e,dstAddress:n,value:r,amount:new fe.default(r).div(10**t.decimals).toString(),raw:m}}};var ge=v(require("bignumber.js")),K=require("ethers"),$=require("@solana/web3.js"),_=require("@solana/spl-token");var G=class extends f{isValidTransferType(e){return e!="CONTRACT"}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);let m=new $.PublicKey(e),y=new $.PublicKey(t.address),T=new $.PublicKey(o),h=await(0,_.getAssociatedTokenAddress)(y,m),b=await(0,_.getAssociatedTokenAddress)(y,T,!0),w=new $.Transaction().add((0,_.createTransferInstruction)(h,b,m,Number(r),[],_.TOKEN_PROGRAM_ID)).add(new $.TransactionInstruction({keys:[{pubkey:m,isSigner:!0,isWritable:!0}],data:Buffer.from((0,K.hexlify)((0,K.toUtf8Bytes)(u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`)),"utf-8"),programId:new $.PublicKey("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr")}));return{srcAddress:e,dstAddress:n,value:r,amount:new ge.default(r).div(10**t.decimals).toString(),raw:w}}};var oe=v(require("bignumber.js")),E=v(require("tonweb"));var W=class extends f{isValidTransferType(e){return e!="CONTRACT"}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);let m=u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`,y=new E.default.Address(e),T=new E.default.Address(o),h=new E.default.boc.Cell;if(h.bits.writeUint(0,128),h.bits.writeString(m),t.isNative)return{srcAddress:e,dstAddress:n,value:r,amount:new oe.default(r).div(10**t.decimals).toString(),raw:h};{let b=new Date().getHours()*3600+new Date().getMinutes()*60+new Date().getSeconds(),w=new E.default.boc.Cell;w.bits.writeUint(260734629,32),w.bits.writeUint(b,64),w.bits.writeCoins(new E.default.utils.BN(r)),w.bits.writeAddress(T),w.bits.writeAddress(y),w.bits.writeBit(!1),w.bits.writeCoins(E.default.utils.toNano("0")),w.bits.writeBit(!0),w.refs.push(h);let I=E.default.utils.bytesToBase64(await w.toBoc(!1));return{srcAddress:e,dstAddress:n,value:r,amount:new oe.default(r).div(10**t.decimals).toString(),raw:I}}}};var Te=v(require("bignumber.js"));var H=class extends f{isValidTransferType(e){return e!="CONTRACT"}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);if(e!==n)throw new Error("ZKSync Lite not support cross address tranfer.");let m=u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`;return{srcAddress:e,dstAddress:n,value:r,amount:new Te.default(r).div(10**t.decimals).toString(),raw:m}}};var M=require("tronweb");var q=class extends f{isValidTransferType(e){return e!="EOA"}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);if(!c)throw new Error("contractAddress is required");let m=this.getUrl(l);if(!m)throw new Error(`Unsupported Tron chainId: ${l}`);let y=new M.TronWeb({fullHost:m}),T=u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`,h=y.toHex(T),b="transferToken(address,address,uint256,bytes)",w=[{type:"address",value:t.address},{type:"address",value:o},{type:"uint256",value:r},{type:"bytes",value:h}],I=await y.transactionBuilder.triggerSmartContract(c,b,{txLocal:!0},w,e);return{srcAddress:e,dstAddress:n,value:r,amount:new M.BigNumber(r).div(10**t.decimals).toString(),raw:I}}async createApprove(e,t,n,i,r){let a=this.getUrl(i);if(!a)throw new Error(`Unsupported Tron chainId: ${i}`);let s=new M.TronWeb({fullHost:a}),o="approve(address,uint256)",l=[{type:"address",value:t},{type:"uint256",value:r}],c=await s.transactionBuilder.triggerSmartContract(n.address,o,{txLocal:!0},l,e);return{ownerAddress:e,spenderAddress:t,value:r,amount:new M.BigNumber(r).div(10**n.decimals).toString(),raw:c}}async createAllowance(e,t,n,i){let r=this.getUrl(i);if(!r)throw new Error(`Unsupported Tron chainId: ${i}`);let a=new M.TronWeb({fullHost:r}),s="allowance(address,address)",o=[{type:"address",value:e},{type:"address",value:t}];return await a.transactionBuilder.triggerSmartContract(n.address,s,{txLocal:!0},o,e)}getUrl(e){let t;return e==="3448148188"?t="https://nile.trongrid.io":e==="728126428"?t="https://api.trongrid.io":e==="2494104990"&&(t="https://api.shasta.trongrid.io"),t}};var he=v(require("bignumber.js")),j=v(require("bitcoinjs-lib"));var Z=class extends f{isValidTransferType(e){return e!="CONTRACT"}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);if(!t.isNative)throw new Error("only support native currency");let m=new j.Psbt;m.addOutput({address:o,value:Number(r)});let y=j.payments.embed({data:[Buffer.from(u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`,"utf-8")]}).output;if(!y)throw new Error("create callDataBuffer failed");return m.addOutput({script:y,value:0}),{srcAddress:e,dstAddress:n,value:r,amount:new he.default(r).div(10**t.decimals).toString(),raw:m}}};var we=v(require("bignumber.js")),J=require("ethers");var X=class extends f{isValidTransferType(e){return e!="CONTRACT"}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);let m=(0,J.hexlify)((0,J.toUtf8Bytes)(u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`));return{srcAddress:e,dstAddress:n,value:r,amount:new we.default(r).div(10**t.decimals).toString(),raw:m}}};var be=v(require("bignumber.js")),Y=require("ethers");var z=class extends f{isValidTransferType(e){return e!="EOA"}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);let m=(0,Y.hexlify)((0,Y.toUtf8Bytes)(u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`)),y={function:`${c}::message::transfer_token`,typeArguments:[t.address],functionArguments:[o,Number(r),m]};return{srcAddress:e,dstAddress:n,value:r,amount:new be.default(r).div(10**t.decimals).toString(),raw:y}}};var Ce=v(require("bignumber.js")),ee=require("ethers");var Q=class extends f{isValidTransferType(e){return e!="EOA"}async createTransaction(e,t,n,i,r,a,s,o,l,c,u){if(!this.isValidTransferType(s))throw new Error(`not support for router type: ${s}`);let m=(0,ee.hexlify)((0,ee.toUtf8Bytes)(u?`c=${a}&t=${n}&app=${u}`:`c=${a}&t=${n}`));return{srcAddress:e,dstAddress:n,value:r,amount:new Ce.default(r).div(10**t.decimals).toString(),raw:m}}};var te=class{constructor(e){g(this,"_services",{});g(this,"configService");this.configService=e}getVMService(e){return this._services[e]?this._services[e]:this.createVMService(e)}createVMService(e){let t;switch(e){case S.VMType.EVM:t=new P(this.configService);break;case S.VMType.IMXVM:t=new U(this.configService);break;case S.VMType.LPRVM:t=new D(this.configService);break;case S.VMType.SOLANAVM:t=new G(this.configService);break;case S.VMType.CAIROVM:t=new L(this.configService);break;case S.VMType.TVM:t=new W(this.configService);break;case S.VMType.ZKLITEVM:t=new H(this.configService);break;case S.VMType.TRONVM:t=new q(this.configService);break;case S.VMType.BTCVM:t=new Z(this.configService);break;case S.VMType.FUELVM:t=new X(this.configService);break;case S.VMType.APTOSVM:t=new z(this.configService);break;case S.VMType.SUIVM:t=new Q(this.configService);break;default:t=void 0;break}return t&&(this._services[e]=t),t}};var pe=(t=>(t.AVAILABLE="available",t.DISABLED="disabled",t))(pe||{});var ne=class{constructor(e){g(this,"apiKey");g(this,"dealerId");g(this,"channelId");g(this,"_apiService");g(this,"_chainConfigs");g(this,"_routerConfigs");g(this,"_basePointRules");g(this,"_tokens");this._apiService=e}async initConfig(){try{let e=await this._apiService.getChainList();this._chainConfigs=e}catch(e){let t=e;throw new Error(`init chainConfigs fail, error: ${t.message}, stack: ${t.stack}`)}try{let e=await this._apiService.getRouterList(this.dealerId);this._routerConfigs=e.filter(t=>t.state==="available")}catch(e){let t=e;throw new Error(`init routerConfigs fail, error: ${t.message}, stack: ${t.stack}`)}try{let e=await this._apiService.getBasePointRules();this._basePointRules=e}catch(e){console.error(`init basePointRules fail, error: ${e.message}`),this._basePointRules={}}}getRouterConfigs(){if(!this._routerConfigs)throw new Error("getRouterConfigs fail, error: config need init.");return this._routerConfigs}getRouterConfig(e){if(!this._routerConfigs)throw new Error("getRouterConfig fail, error: config need init.");let t=`${e.srcChainId}/${e.dstChainId}-${e.srcTokenSymbol}/${e.dstTokenSymbol}`;return this._routerConfigs.find(n=>n.line===t)}getChainConfigs(){if(!this._chainConfigs)throw new Error("getChainConfigs fail, error: config need init.");return this._chainConfigs}getChainConfigByName(e){if(!this._chainConfigs)throw new Error("getChainConfigByName fail, error: config need init.");return this._chainConfigs.find(n=>n.name===e)}getChainConfigById(e){if(!this._chainConfigs)throw new Error("getChainConfigById fail, error: config need init.");return this._chainConfigs.find(n=>n.chainId===e)}getBasePointRule(e,t){if(!this._basePointRules)throw new Error("getBasePointRule fail, error: config need init.");let n=this._basePointRules[e],i="0";return n&&(i=n[t]||"0"),i}};var F=class{constructor(e,t,n){g(this,"apiEndpoint");g(this,"cdnEndpoint");g(this,"apiKey");g(this,"channelId");this.apiEndpoint=e,this.apiKey=t,this.channelId=n,e=="https://api.orbiter.finance/sdk"?this.cdnEndpoint="https://cdn.orbiter.finance/config":this.cdnEndpoint="https://testnet-cdn.orbiter.finance/config"}async fetchAPIGet(e,t){let n=new URL(`${this.apiEndpoint}${e}`);t&&Object.keys(t).forEach(s=>{let o=t[s];o&&n.searchParams.append(s,o)});let i={"Content-Type":"application/json"};i["X-Channel"]="bridge-sdk",this.apiKey&&(i["X-API-Key"]=this.apiKey),this.channelId&&(i["X-Channel-ID"]=this.channelId);let r=await fetch(n.toString(),{method:"GET",headers:i});if(!r.ok)throw new Error(`Error ${r.status}: ${r.statusText}`);let a=await r.json();if(a.status!=="success")throw new Error(a.message);return a.result}async fetchCDNGet(e){let t=new URL(`${this.cdnEndpoint}${e}`),n={"Content-Type":"application/json"},i=await fetch(t.toString(),{method:"GET",headers:n});if(!i.ok)throw new Error(`Error ${i.status}: ${i.statusText}`);return await i.json()}async getChainList(){let e=[];try{e=await this.fetchAPIGet("/chains")}catch{console.log("getChainList From API Fail, will try cdn backup"),e=await this.fetchCDNGet("/chains.json")}return e}async getTokenList(){return await this.fetchAPIGet("/tokens")}async getRouterList(e){let t="contract",n=[];try{n=await this.fetchAPIGet("/routers/v2",e?{dealerId:e,entry:t}:{entry:t})}catch{console.log("getRouterList From API Fail, will try cdn backup"),n=await this.fetchCDNGet("/routers.json")}return n}async getBasePointRules(){return await this.fetchAPIGet("/routers/base-point")}async getSimulatedReceiveAmount(e,t,n,i,r){return await this.fetchAPIGet("/routers/simulation/receiveAmount",{line:e,value:t,nonce:n,dealer:i,brokerageTradeFeeRate:r})}async getTransactionHistory(e,t){return await this.fetchAPIGet("/transaction/history",{address:e,offset:t})}async getTransactionStatus(e){return await this.fetchAPIGet(`/transaction/status/${e}`)}async getUserOpoint(e){return await this.fetchAPIGet(`/opoints/user/${e}`)}};var d=v(require("bignumber.js")),x=require("@orbiter-finance/vm-core");function ue(p,e,t=" "){let n=e-p.length;return n<=0?p:t.repeat(Math.ceil(n/t.length)).slice(0,n)+p}async function ve(p,e){let n=await fetch(`${p==="TON"?"https://tonapi.io":"https://testnet.tonapi.io"}/v2/traces/${e}`,{method:"GET"});if(!n.ok)throw new Error(`Error ${n.status}: ${n.statusText}`);return(await n.json()).children?.[0]?.transaction?.hash}var N=class{constructor(e,t,n,i,r,a,s,o,l){this.srcChainConfig=e;this.srcToken=t;this.dstChainConfig=n;this.dstToken=i;this.basePoint=r;this._VMService=a;this.routerConfig=s;this.routerType=o;this._channelId=l}get routerId(){return`${this.routerType}-${this.srcChainConfig.chainId}-${this.srcToken.symbol}-${this.dstChainConfig.chainId}-${this.dstToken.symbol}`}get vc(){return this.dstChainConfig.internalId.toString()}get withholdingFee(){return this.routerConfig.withholdingFee}get tradeFee(){return this.routerConfig.tradeFee}get makerAddress(){let e=this.routerConfig?.endpoint;if(!e)throw new Error("getMakerAddress fail");return e}get contractAddress(){return this.routerConfig.endpointContract}get spentTime(){return this.routerConfig.spentTime}_getAmountWithVc(e){let t=new d.default(e).multipliedBy(10**this.srcToken.decimals).toFixed(0),n=this.vc;if(t.length<=n.length)throw new Error("value length too short");let r=t.slice(0,t.length-n.length)+n;return new d.default(r).div(10**this.srcToken.decimals).toFixed()}async createTransaction(e,t,n){let i=new d.default(n).multipliedBy(10**this.srcToken.decimals).toFixed(0);if(!await(0,x.isValidAddress)(e,this.srcChainConfig.vm))throw new Error(`srcAddress format error: ${e}`);let r=this.vc;return await this._VMService.createTransaction(e,this.srcToken,t,this.dstToken,i,r,this.routerType,this.makerAddress,this.srcChainConfig.chainId,this.contractAddress,this._channelId)}async createApprove(e,t){let n=new d.default(t).multipliedBy(10**this.srcToken.decimals).toFixed(0);if(this.routerType==="EOA")throw new Error("EOA Transfer no need approve.");let i=this.contractAddress;if(!i)throw new Error("createApprove fail, unavailable target contract address.");if(!await(0,x.isValidAddress)(e,this.srcChainConfig.vm))throw new Error(`ownerAddress format error: ${e}`);if(!await(0,x.isValidAddress)(i,this.srcChainConfig.vm))throw new Error(`spenderAddress format error: ${i}`);return this._VMService.createApprove(e,i,this.srcToken,this.srcChainConfig.chainId,n)}async createAllowance(e){if(this.routerType==="EOA")throw new Error("EOA Transfer no need approve.");let t=this.contractAddress;if(!t)throw new Error("createAllowance fail, unavailable target contract address.");if(!await(0,x.isValidAddress)(e,this.srcChainConfig.vm))throw new Error(`ownerAddress format error: ${e}`);if(!await(0,x.isValidAddress)(t,this.srcChainConfig.vm))throw new Error(`spenderAddress format error: ${t}`);return this._VMService.createAllowance(e,t,this.srcToken,this.srcChainConfig.chainId)}getMinSendAmountMinusWithHoldingFee(){let e=new d.default(this.routerConfig.minAmt),t=new d.default(this.routerConfig.withholdingFee);return e.minus(t).toFixed()}getMinSendAmount(){return this.routerConfig.minAmt}getMaxSendAmount(){return this.routerConfig.maxAmt}simulationAmountPlusWithHoldingFee(e){let t=new d.default(e);this.routerType=="EOA"&&(t=new d.default(this._getAmountWithVc(e)));let n=new d.default(this.getMinSendAmountMinusWithHoldingFee()),i=new d.default(this.getMaxSendAmount());if(t.lt(n)||t.gt(i.multipliedBy(1.1)))throw new Error(`amount ${e} is not in the allow scale: min: ${this.routerConfig.minAmt} max: ${this.routerConfig.maxAmt}`);let r=new d.default(this.tradeFee),a=new d.default(this.withholdingFee),s=a;if(this.routerConfig.tieredFee){let h=t.minus(a).toNumber(),b=this.routerConfig.tieredFee.find(w=>h>w.range[0]&&h<=w.range[1]);b&&(b.tradeFee!=null&&(r=new d.default(b.tradeFee)),b.withholdingFee!=null&&(a=new d.default(b.withholdingFee)))}let o=new d.default(s).minus(a).multipliedBy(r).dividedBy(100).toString();a=new d.default(this.routerConfig.withholdingFee).minus(o),t=t.plus(a);let l="0",c=this._getTargetAmountSafeLengthByToken(this.dstToken.symbol,this.dstToken.decimals),u=ue(l.substring(l.length-c),c,"0"),m=this._getResponseIntent(t.toString(),"0",r.toNumber(),0,a.toString(),u,this.dstToken.decimals-c),y=t.toFixed(),T=new d.default(m.responseAmount).toFixed();return{sendAmount:y,receiveAmount:T}}simulationAmount(e){let t=new d.default(e);if(this.routerType==="EOA"&&(t=new d.default(this._getAmountWithVc(e))),t.lt(Number(this.routerConfig.minAmt))||t.gt(Number(this.routerConfig.maxAmt)*1.1))throw new Error(`amount ${e} is not in the allow scale: min: ${this.routerConfig.minAmt} max: ${this.routerConfig.maxAmt}`);let n=new d.default(this.tradeFee),i=new d.default(this.withholdingFee),r=i;if(this.routerConfig.tieredFee){let y=t.minus(i).toNumber(),T=this.routerConfig.tieredFee.find(h=>y>h.range[0]&&y<=h.range[1]);T&&(T.tradeFee!=null&&(n=new d.default(T.tradeFee)),T.withholdingFee!=null&&(i=new d.default(T.withholdingFee)))}let a=new d.default(r).minus(i).multipliedBy(n).dividedBy(100).toString();i=new d.default(this.routerConfig.withholdingFee).minus(a);let s="1000",o=this._getTargetAmountSafeLengthByToken(this.dstToken.symbol,this.dstToken.decimals),l=ue(s.substring(s.length-o),o,"0"),c=this._getResponseIntent(t.toString(),"0",n.toNumber(),0,i.toString(),l,this.dstToken.decimals-o),u=t.toFixed(),m=new d.default(c.responseAmount).toFixed();return{sendAmount:u,receiveAmount:m}}_getResponseIntent(e,t,n,i,r,a,s){let o=new d.default(e),l=o.minus(t).minus(r),c=l.times(n).div(100),u=l.times(i||0).div(100),y=l.minus(c).minus(u).toFixed(s,1),T=y.split("."),h=T[1]||"";return{code:0,value:o.toString(),tradeAmount:l.toString(),tradeFeeAmount:c.toString(),brokerageTradeFeeAmount:u.toString(),withholdingFeeAmount:r,responseAmountOrigin:y,responseAmount:new d.default(`${T[0]}.${h.substring(0,s)}${a}`).toString()}}_getTargetAmountSafeLengthByToken(e,t){return t>=18?5:e==="BTC"?2:4}};var ce=class p{constructor(e){g(this,"_config");g(this,"_apiService");g(this,"_configService");g(this,"_VMServiceFactory");g(this,"_defaultRouterType");this._config=e,this._apiService=new F(this._config.apiEndpoint,this._config.apiKey,this._config.channelId),this._configService=new ne(this._apiService),this._VMServiceFactory=new te(this._configService),this._defaultRouterType=this._config.defaultRouterType||"CONTRACT"}async init(){await this._configService.initConfig()}static async create(e){let t=new p(e);return await t.init(),t}createRouter(e){let t=this._configService.getChainConfigById(e.srcChainId);if(!t)throw new Error(`createRouter fail, error: unavailable source chainId: ${e.srcChainId}.`);let n=this._VMServiceFactory.getVMService(t.vm);if(!n)throw new Error(`createRouter fail, error: unavailable source chain vm type: ${t.vm}.`);let i=t.tokens.find(c=>c.symbol===e.srcTokenSymbol);if(!i)throw new Error(`createRouter fail, error: unavailable source token: ${e.srcTokenSymbol}.`);let r=this._configService.getChainConfigById(e.dstChainId);if(!r)throw new Error(`createRouter fail, error: unavailable destination chainId: ${e.dstChainId}.`);let a=r.tokens.find(c=>c.symbol===e.dstTokenSymbol);if(!a)throw new Error(`createRouter fail, error: unavailable destination token: ${e.srcTokenSymbol}.`);let s=this._configService.getRouterConfig(e);if(!s)throw new Error(`createRouter fail, error: unavailable router, line: '${e.srcChainId}/${e.dstChainId}-${e.srcTokenSymbol}/${e.dstTokenSymbol}.`);if(e.routerType){if(!this.checkTradePairType(t,r,s,e.routerType))throw new Error(`createRouter fail, error: error: unavailable router, line: '${e.srcChainId}/${e.dstChainId}-${e.srcTokenSymbol}/${e.dstTokenSymbol} not support for router type: ${e.routerType}.`)}else if(e.routerType=this._defaultRouterType,!this.checkTradePairType(t,r,s,e.routerType)&&(e.routerType=this._defaultRouterType=="EOA"?"CONTRACT":"EOA",!this.checkTradePairType(t,r,s,e.routerType)))throw new Error(`createRouter fail, error: unavailable router, line: '${e.srcChainId}/${e.dstChainId}-${e.srcTokenSymbol}/${e.dstTokenSymbol}.`);let o=this._configService.getBasePointRule(e.dstChainId,e.dstTokenSymbol),l=this._config.channelId?.indexOf("official-")==0?void 0:this._config.channelId;return new N(t,i,r,a,o,n,s,e.routerType,l)}checkTradePairType(e,t,n,i){if(i=="EOA"){if(e.vm==t.vm||e.vm==k.VMType.EVM&&[k.VMType.LPRVM,k.VMType.ZKLITEVM,k.VMType.ZKSPVM].includes(t.vm)||t.vm==k.VMType.EVM&&[k.VMType.LPRVM,k.VMType.ZKLITEVM,k.VMType.ZKSPVM].includes(e.vm)||[k.VMType.TVM,k.VMType.SOLANAVM,k.VMType.FUELVM].includes(e.vm))return!0}else if(i=="CONTRACT"&&i=="CONTRACT"&&n.endpointContract)return!0;return!1}getAllChains(){return[...this._configService.getChainConfigs().map(t=>({id:t.chainId,name:t.name}))]}getAllSymbols(){let e=this.getAllChains(),t=new Set;return e.forEach(n=>{this.getAvailableTokens(n.id).forEach(r=>{t.add(r.symbol)})}),[...t]}getChainConfig(e){return this._configService.getChainConfigById(e)}getAvailableTokens(e){let t=this._configService.getChainConfigById(e),n=[];if(t){let a=this._configService.getRouterConfigs().filter(s=>s.srcChain===t.chainId).map(s=>s.srcToken);n=t.tokens.filter(s=>a.includes(s.address))}return n}getAllTradePairs(){let e=this._configService.getRouterConfigs(),t=[];return e.forEach(n=>{let i=this._configService?.getChainConfigById(n.srcChain),r=this._configService?.getChainConfigById(n.tgtChain);if(r){let a=i?.tokens.find(o=>o.address===n.srcToken),s=r?.tokens.find(o=>o.address===n.tgtToken);i&&r&&a&&s&&t.push({srcChainId:n.srcChain,dstChainId:n.tgtChain,srcTokenSymbol:a.symbol,dstTokenSymbol:s.symbol})}}),t}getAvailableTradePairs(e,t){return this.getAllTradePairs().filter(i=>!(e&&i.srcChainId!=e||t&&i.srcTokenSymbol!=t))}async getTransactionHistory(e,t=0){return await this._apiService.getTransactionHistory(e,t)}async getTransactionStatus(e,t){if(t?.includes("TON"))try{e=await ve(t,e)}catch(n){console.error(`getTonOrbiterHash error ${n.message}`)}return await this._apiService.getTransactionStatus(e)}async getUserOpoint(e){return await this._apiService.getUserOpoint(e)}};0&&(module.exports={ApiService,CDNENDPOINT,ENDPOINT,OrbiterClient,Router,RouterState,RouterType});
//# sourceMappingURL=index.js.map